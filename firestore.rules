rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if the user is authenticated and matches the requested ID
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Check if the document has the user's ID stamped on it (Resource Ownership)
    function isResourceOwner() {
      return request.auth != null && (
        // Allow creating if you stamp your own ID
        (request.method == 'create' && request.resource.data.userId == request.auth.uid) ||
        // Allow reading/updating/deleting if the existing doc has your ID
        (resource.data.userId == request.auth.uid)
      );
    }

    // Validate Ledger Entry Structure (Data Integrity)
    function isValidLedgerEntry() {
      let incoming = request.resource.data;
      return 
        incoming.amount is number && 
        incoming.date is string && 
        incoming.date.matches('^\\d{4}-\\d{2}-\\d{2}$') && // Must be YYYY-MM-DD
        (incoming.type == 'sale' || incoming.type == 'payment' || incoming.type == 'purchase' || incoming.type == 'return');
    }

    // --- RULES ---

    // 1. USER PROFILE (Private)
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // 2. CUSTOMERS (Root Level)
    match /customers/{customerId} {
      allow read: if isResourceOwner();
      allow write: if isResourceOwner(); 
      // Note: We could add schema validation for customers here too

      // Customer Ledger
      match /ledger/{entryId} {
         allow read: if get(/databases/$(database)/documents/customers/$(customerId)).data.userId == request.auth.uid;
         allow write: if get(/databases/$(database)/documents/customers/$(customerId)).data.userId == request.auth.uid
                      && (request.method == 'delete' || isValidLedgerEntry());
      }
    }

    // 3. SUPPLIERS (Root Level)
    match /suppliers/{supplierId} {
      allow read, write: if isResourceOwner();
      
      match /ledger/{entryId} {
         allow read: if get(/databases/$(database)/documents/suppliers/$(supplierId)).data.userId == request.auth.uid;
         allow write: if get(/databases/$(database)/documents/suppliers/$(supplierId)).data.userId == request.auth.uid
                      && (request.method == 'delete' || isValidLedgerEntry());
      }
    }

    // 4. EXPENSES (Root Level - if used)
    match /expenses/{expenseId} {
        allow read, write: if isResourceOwner();
    }
  }
}
